import java.nio.file.Paths
import java.nio.file.Files
import ch.so.agi.gretl.tasks.*
import ch.so.agi.gretl.api.*

apply plugin: 'ch.so.agi.gretl'

defaultTasks 'runTest'

class SecureString {
    private final String value
    
    SecureString(String value) {
        this.value = value
    }
    
    // Wird bei println, logger, Exceptions aufgerufen
    @Override
    String toString() {
        value
            ?.replaceAll(/(password=)[^\s;&'"]+/, '$1***') 
            ?.replaceAll(/(user=)[^\s;&'"]+/, '$1***') 
            ?: ''
    }
    
    // Echter Wert für die Library
    String getValue() {
        return value
    }
}

// DuckDB Initialisierung
def duckDbPath = "${buildDir}/temp.duckdb"
def duckDbUri = "jdbc:duckdb:${duckDbPath}"
def duckDbFile = file(duckDbPath)

if (duckDbFile.exists()) {
    duckDbFile.delete()
    println 'Deleted existing DuckDB database.'
} else if (duckDbFile.parentFile.mkdirs()) {
    println 'Created build directory for DuckDB database.'
} else {
    println 'Found build directory without existing DuckDB database. No action taken.'
}

def dbHostPub = dbUriPub.substring(dbUriPub.indexOf("//") + 2, dbUriPub.lastIndexOf("/"))
def dbDatabasePub = dbUriPub.substring(dbUriPub.lastIndexOf("/") + 1)
def dbConnectionStringPub = new SecureString("'dbname=$dbDatabasePub user=$dbUserPub password=$dbPwdPub host=$dbHostPub'")

def dbHostEdit = dbUriEdit.substring(dbUriPub.indexOf("//") + 2, dbUriEdit.lastIndexOf("/"))
def dbDatabaseEdit = dbUriEdit.substring(dbUriEdit.lastIndexOf("/") + 1)
def dbConnectionStringEdit = new SecureString("'dbname=$dbDatabaseEdit user=$dbUserEdit password=$dbPwdEdit host=$dbHostEdit'")

def dbHostSimi = dbUriSimi.substring(dbUriSimi.indexOf("//") + 2, dbUriSimi.lastIndexOf("/"))
def dbDatabaseSimi = dbUriSimi.substring(dbUriSimi.lastIndexOf("/") + 1)
def dbConnectionStringSimi = new SecureString("'dbname=$dbDatabaseSimi user=$dbUserSimi password=$dbPwdSimi host=$dbHostSimi'")


//-----------

tasks.register('connectionStrings') {
    description "Diesen Task löschen!"
    doLast {
        println 'dbConnectionStringPub: ' + dbConnectionStringPub
        println 'dbConnectionStringEdit: ' + dbConnectionStringEdit
        println 'dbConnectionStringSimi: ' + dbConnectionStringSimi
    }
}

tasks.register('connectPub', SqlExecutor) {
    dependsOn 'connectionStrings'
    database = [duckDbUri] 
    sqlFiles = files("read_pubdb.sql")
    sqlParameters = [
        connectionStringPub : dbConnectionStringPub.getValue() //as String
        //connectionStringPub : testCString
        ]
}
tasks.register('connectEdit', SqlExecutor) {
    dependsOn 'connectPub'
    database = [duckDbUri] 
    sqlFiles = files("read_editdb.sql")
    sqlParameters = [
        connectionStringEdit : dbConnectionStringEdit.getValue()  //as String
        ]
}
tasks.register('connectSimi', SqlExecutor) {
    dependsOn 'connectEdit'
    database = [duckDbUri] 
    sqlFiles = files("read_simidb.sql")
    sqlParameters = [
        connectionStringSimi : dbConnectionStringSimi.getValue()  //as String
        ]
}

tasks.register('runTest') {
    dependsOn 'connectSimi'
    doLast {
        println 'Alle Tests ausgeführt'
    }
}



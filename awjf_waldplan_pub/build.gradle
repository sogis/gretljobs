import ch.so.agi.gretl.tasks.*
import ch.so.agi.gretl.api.*
import ch.so.agi.gretl.api.TransferSet

apply plugin: 'ch.so.agi.gretl'

defaultTasks 'copyDataFromPub'

// Multiline-Text ist im Task nicht möglich, darum als Variable
def importModelsPub = 
    'SO_AGI_MOpublic_20240711;' +
    'SO_AWJF_Waldplan_Publikation_20250312;'

tasks.register('createExtension', SqlExecutor) {
    description = 'In der Processing-DB die Extension für die UUID-Erstellung aktivieren (uuid-ossp).'
    database = [dbUriProcessing, dbUserProcessing, dbPwdProcessing]
    sqlFiles = files('create_extension.sql')
}

tasks.register('createImportSchema_Waldplan_Edit', Ili2pgImportSchema) {
    dependsOn 'createExtension'
    description = 'Waldplan-Schema IMPORT für Quelldaten in der Processing-DB anlegen'
    database = [dbUriProcessing, dbUserProcessing, dbPwdProcessing]
    models = 'SO_AWJF_Waldplan_20250312'
    dbschema = 'awjf_waldplan_v2'
    createGeomIdx = true
    createFk = true
    createFkIdx = true
    createUnique = true
    createEnumTabs = true
    beautifyEnumDispName = true
    createMetaInfo = true
    createNumChecks = true
    strokeArcs = true
    createBasketCol = true
    createDatasetCol = true
    nameByTopic = true
    createStdCols = true
}

tasks.register('createImportSchema_Waldplan_Pub', Ili2pgImportSchema) {
    dependsOn 'createImportSchema_Waldplan_Edit'
    description = 'Schema IMPORT für Quelldaten in der Processing-DB anlegen.'
    database = [dbUriProcessing, dbUserProcessing, dbPwdProcessing]
    models = 'SO_AWJF_Waldplan_Publikation_20250312'
    dbschema = 'awjf_waldplan_pub_v2'
    createGeomIdx = true
    createFk = true
    createFkIdx = true
    createUnique = true
    createEnumTabs = true
    beautifyEnumDispName = true
    createMetaInfo = true
    createNumChecks = true
    strokeArcs = true
    createEnumTxtCol = true
    createBasketCol = false
    createDatasetCol = false
    nameByTopic = true
}

tasks.register('createImportSchema_Mopublic', Ili2pgImportSchema) {
    dependsOn 'createImportSchema_Waldplan_Pub'
    description = 'Schema IMPORT für Quelldaten in der Processing-DB anlegen.'
    database = [dbUriProcessing, dbUserProcessing, dbPwdProcessing]
    models = 'SO_AGI_MOpublic_20240711'
    dbschema = 'agi_mopublic_pub'
    nameByTopic = true
    beautifyEnumDispName = true
    strokeArcs = true
    createEnumTabs = false
    createNumChecks = true
    createFk = true
    createFkIdx = true
    createGeomIdx = true
    createMetaInfo = true
    createBasketCol = false
    createUnique = true
    smart2Inheritance = true
}

tasks.register('copyDataFromEdit', Db2Db) {
    dependsOn 'createImportSchema_Mopublic'
    description = 'Quelldaten tabellenweise aus der Edit-DB in die Processing-DB kopieren.'
    sourceDb = [dbUriEdit, dbUserEdit, dbPwdEdit]
    targetDb = [dbUriProcessing, dbUserProcessing, dbPwdProcessing]
    transferSets = [
        new TransferSet('import_to_processing/import_waldplan_dataset.sql', 'awjf_waldplan_v2.t_ili2db_dataset', true),
        new TransferSet('import_to_processing/import_waldplan_basket.sql', 'awjf_waldplan_v2.t_ili2db_basket', true),
        new TransferSet('import_to_processing/import_waldplan_schutzwald.sql', 'awjf_waldplan_v2.waldplan_schutzwald', true),
        new TransferSet('import_to_processing/import_waldplankatalog_forstbetrieb.sql', 'awjf_waldplan_v2.waldplankatalog_forstbetrieb', true),
        new TransferSet('import_to_processing/import_waldplankatalog_forstrevier.sql', 'awjf_waldplan_v2.waldplankatalog_forstrevier', true),
        new TransferSet('import_to_processing/import_waldplan_waldfunktion.sql', 'awjf_waldplan_v2.waldplan_waldfunktion', true),
        new TransferSet('import_to_processing/import_waldplan_waldnutzung.sql', 'awjf_waldplan_v2.waldplan_waldnutzung', true),
        new TransferSet('import_to_processing/import_waldplan_waldeigentum.sql', 'awjf_waldplan_v2.waldplan_waldeigentum', true)
    ];
}

tasks.register('copyDataFromPub', Db2Db) {
    dependsOn 'copyDataFromEdit'
    description = 'Quelldaten tabellenweise aus der Pub-DB in die Processing-DB kopieren.'
    sourceDb = [dbUriPub, dbUserPub, dbPwdPub]
    targetDb = [dbUriProcessing, dbUserProcessing, dbPwdProcessing]
    transferSets = [
        new TransferSet('import_to_processing/import_mopublic_grundstueck.sql', 'agi_mopublic_pub.mopublic_grundstueck', true)
    ];
}

/*
tasks.register("transferData", Db2Db) {
    sourceDb = [dbUriEdit, dbUserEdit, dbPwdEdit]
    targetDb = [dbUriPub, dbUserPub, dbPwdPub]
    sqlParameters = [bfsnr_param:bfsnr]
    transferSets = [
            new TransferSet('awjf_waldfunktion_pub.sql', 'awjf_waldplan_pub_v2.waldplan_waldfunktion', true),
            new TransferSet('awjf_waldnutzung_pub.sql', 'awjf_waldplan_pub_v2.waldplan_waldnutzung', true), 
            new TransferSet('awjf_schutzwald_pub.sql', 'awjf_waldplan_pub_v2.waldplan_schutzwald', true),
            new TransferSet('awjf_walduebersicht_pub.sql', 'awjf_waldplan_pub_v2.waldplan_walduebersicht', true),
            new TransferSet('awjf_waldplan_grundstueck_pub.sql', 'awjf_waldplan_pub_v2.waldplan_waldplan_grundstueck', true)         
    ];
}


tasks.register("transferData", Db2Db) {
    sourceDb = [dbUriEdit, dbUserEdit, dbPwdEdit]
    targetDb = [dbUriPub, dbUserPub, dbPwdPub]
    transferSets = [
            new TransferSet('alle_gemeinden/awjf_waldfunktion_pub.sql', 'awjf_waldplan_pub_v2.waldplan_waldfunktion', true),
            new TransferSet('alle_gemeinden/awjf_waldnutzung_pub.sql', 'awjf_waldplan_pub_v2.waldplan_waldnutzung', true), 
            new TransferSet('alle_gemeinden/awjf_schutzwald_pub.sql', 'awjf_waldplan_pub_v2.waldplan_schutzwald', true),
            new TransferSet('alle_gemeinden/awjf_walduebersicht_pub.sql', 'awjf_waldplan_pub_v2.waldplan_walduebersicht', true),
            new TransferSet('alle_gemeinden/awjf_waldplan_grundstueck_pub.sql', 'awjf_waldplan_pub_v2.waldplan_waldplan_grundstueck', true)         
    ];
}

tasks.register("UpdateFlaeche", SqlExecutor) {
    dependsOn "transferData"
    database = [dbUriPub, dbUserPub, dbPwdPub]
    sqlParameters = [bfsnr_param:bfsnr]
    sqlFiles = files('awjf_update_flaechenwerte.sql'
    )
}
*/
/*
* Aktivieren sobald produktiv

tasks.register('validateData', Ili2pgValidate) {
    dependsOn "transferData"
    database = [dbUriPub, dbUserPub, dbPwdPub]
    models = "SO_AWJF_Waldplan_Publikation_20250312"
    dbschema = "awjf_waldplan_pub_v2"
}
*/
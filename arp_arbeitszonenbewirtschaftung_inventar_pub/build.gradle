import ch.so.agi.gretl.tasks.*
import ch.so.agi.gretl.api.TransferSet

apply plugin: 'ch.so.agi.gretl'

defaultTasks 'datenumbau_pub'

task update_edit(type: SqlExecutor) {
    description = "updatet das Attribut Bemerkung. Setzt alle leeren Strings auf NULL"
    database = [dbUriEdit, dbUserEdit, dbPwdEdit]
    sqlFiles = ["set_empty_string_to_null.sql"]
}

task validate(type: Ili2pgValidate, dependsOn: 'update_edit') {
    database = [dbUriEdit, dbUserEdit, dbPwdEdit]
    models = "SO_ARP_Arbeitszonenbewirtschaftung_20250902"
    dbschema = "arp_arbeitszonenbewirtschaftung_v2"
    failOnException = false
}

task datatransfer_staging(type: Db2Db){
    dependsOn validate
    description "Das Schema arp_arbeitszonenbewirtschaftung_staging wird von der Pub-DB bef端llt. Dieses Staging-Schema braucht es f端r den View. Damit die Bewertungen im Web GIS Client live auf das Grundst端ck (Polygon) publiziert werden"
    sourceDb = [dbUriPub, dbUserPub, dbPwdPub]
    targetDb = [dbUriEdit, dbUserEdit, dbPwdEdit]
    transferSets = [
        new TransferSet('select_staging.sql', 'arp_arbeitszonenbewirtschaftung_staging_v2.arbtsznnng_nvntar_arbeitszonenbewirtschaftung_inventar', true)
    ];
}

task update_staging(type: SqlExecutor, dependsOn: 'datatransfer_staging') {
    description = "Bef端llt die die Attribute die mit createEnumTxtCol angelegt werden"
    database = [dbUriEdit, dbUserEdit, dbPwdEdit]
    sqlFiles = ["update_staging.sql"]
}

task datenumbau_pub(type: Db2Db, dependsOn: 'update_staging') {
    dependsOn update_staging
    sourceDb = [dbUriEdit, dbUserEdit, dbPwdEdit]
    targetDb = [dbUriPub, dbUserPub, dbPwdPub]
    transferSets = [
        new TransferSet('select_region.sql', 'arp_arbeitszonenbewirtschaftung_pub_v2.region_region', true),
        new TransferSet('select_inventar_flaeche.sql', 'arp_arbeitszonenbewirtschaftung_pub_v2.arbtsznnng_nvntar_arbeitszonenbewirtschaftung_inventar', true),
    ];
}
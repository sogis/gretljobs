import ch.so.agi.gretl.tasks.*
import ch.so.agi.gretl.api.TransferSet
import java.nio.file.Paths
import de.undercouch.gradle.tasks.download.Download

apply plugin: 'ch.so.agi.gretl'


defaultTasks 'validateCsvFile'

// Download-Verzeichnis

//////////////////////////////// so hats funktioniert
//def pathToTempFolder = System.getProperty('java.io.tmpdir')
def pathToTempFolder = System.getProperty("user.dir")
def pathToUnzipFolder = Paths.get(pathToTempFolder, 'upload')
def pathToDataZip = Paths.get(pathToTempFolder, '/upload/uploadFile.zip')


task copyZipFile(type: Copy) {
    from "upload/"
    into "upload/"
    include("uploadFile")
    
    
    println "yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy " + pathToDataZip
    rename("uploadFile", "uploadFile.zip")
}

task unzipData(type: Copy, dependsOn: 'copyZipFile'){
    from zipTree(pathToDataZip)
    //////////into file(pathToUnzipFolder)
    include '**/*.csv'
}


task validateCsvFile(type: CsvValidator, dependsOn: 'unzipData') {
    println "zzzzzzzzzzzzzzzzzzzzzzzzzz" +file("upload/absturz.csv")
    modeldir = '.;http://models.geo.admin.ch'                                                                      // spaeter loeschen, wenn Modell im Repo ist
    models = "SO_AFU_Fliessgewaesser_20220228"
    firstLineIsHeader=true
    valueSeparator = ','
    encoding = 'UTF-8'
    dataFiles = [file("upload/absturz.csv")]
}

/*
task deleteFromAfuOekomorphologie(type: SqlExecutor, dependsOn: 'unzipData') {
///////////////////////////////////task deleteFromAfuOekomorphologie(type: SqlExecutor, dependsOn: 'validateCsvFile') {
    database = [dbUriEdit, dbUserEdit, dbPwdEdit]
    sqlFiles = ['delete_from_oekomorphologie_tables.sql']
}

task importAfuFliessgewaesserStaging(type: CsvImport, dependsOn: 'deleteFromAfuOekomorphologie') {
    database = [dbUriEdit, dbUserEdit, dbPwdEdit]
    schemaName = 'afu_fliessgewaesser_staging_v1'
    tableName = 'absturzcsv'
    firstLineIsHeader = true
    valueSeparator = ','
    encoding = 'UTF-8'
    dataFile = "upload/absturz.csv"
}



task transferAfuFliessgewaesser(type: Db2Db, dependsOn: 'importAfuFliessgewaesserStaging') {
    database = [dbUriEdit, dbUserEdit, dbPwdEdit]
    transferSets = [
            new TransferSet('afu_oekomorphologie_transfer.sql', 'zzzzzzzzzzzzzzzzzzzzzzzzzz', true)
    ];
}
*/


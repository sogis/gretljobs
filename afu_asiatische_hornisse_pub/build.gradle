import ch.so.agi.gretl.tasks.*
import ch.so.agi.gretl.api.TransferSet

apply plugin: 'ch.so.agi.gretl'

description = "GRETL-Job für Datenübernahme der Asiatischen Hornisse innerhalb der edit-DB, ins pub-Schema (pub-DB, edit-DB)"


defaultTasks 'transferAfuAsiatischeHornissePub','refreshSolr','createSearchIndex'


task transferAfuAsiatischeHornissePub(type: Db2Db) {
    sourceDb = [dbUriEdit, dbUserEdit, dbPwdEdit]
    targetDb = [dbUriPub, dbUserPub, dbPwdPub]
    transferSets = [
            new TransferSet('afu_asiatische_hornisse_pub.sql',
                    'afu_asiatische_hornisse_pub_v1.asia_hornisse_ash', true)
    ]
}

task refreshSolr(type:Exec, mustRunAfter: 'transferAfuAsiatischeHornissePub') {
        commandLine 'curl', '-i', '--max-time', '5', solrIndexupdaterBaseUrl + '/queue?ds=ch.so.afu.asiatische_hornisse'
}

task createSearchIndex(type: SqlExecutor, mustRunAfter: 'transferAfuAsiatischeHornissePub'){
        database = [dbUriPub, dbUserPub, dbPwdPub]
        def layerName = 'ch.so.afu.asiatische_hornisse'
        def dbSearchSchema = 'agi_suchindex_pub_v1'

        String layerNameString = "'${layerName}'"
        sqlParameters = [
                [layername: layerNameString, db_schema: dbSearchSchema]
        ]
        sqlFiles = [
                '../suchindex_deleteFeatures.sql',
                layerName + '.sql'
        ]
}

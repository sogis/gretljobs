import ch.so.agi.gretl.tasks.*
import ch.so.agi.gretl.api.TransferSet

apply plugin: 'ch.so.agi.gretl'
apply plugin: 'org.hidetake.ssh'

defaultTasks 'sftpListing'

// Definition von Pfaden
def xtfPath = "${buildDir}/test_sftp_agi.txt"
def xtfFile = file(xtfPath)

def remotePathTest = '/opt/daten/gis_arp_raumdaten/test'
def remotePathProd = '/opt/daten/gis_arp_raumdaten/prod'

// Definition des SFTP-Servers für den Datenupload
remotes {
    sftpServerTest {
        host = sftpServerSEinApp
        user = sftpUserSEinApp.replace('_prod', '_test')
        identity = file('/home/gradle/.ssh/id_rsa')
        // Skip host key checking outside the following environments:
        if ( !(gretlEnvironment in ['test', 'integration', 'production']) ) {  // uses the Groovy membership operator
            knownHosts = allowAnyHosts
        }
    }
    sftpServerProd {
        host = sftpServerSEinApp
        user = sftpUserSEinApp.replace('_test', '_prod')
        identity = file('/home/gradle/.ssh/id_rsa')
        // Skip host key checking outside the following environments:
        if ( !(gretlEnvironment in ['test', 'integration', 'production']) ) {  // uses the Groovy membership operator
            knownHosts = allowAnyHosts
        }
    }
}

tasks.register('writeTest') {
    def outputFile = xtfFile

    // Erstelle das Verzeichnis, falls es nicht existiert
    if (!outputFile.parentFile.exists()) {
        outputFile.parentFile.mkdirs()
        println "Verzeichnis erstellt: ${outputFile.parentFile.absolutePath}"
    }

    // Erstelle die Datei zuerst
    if (!outputFile.exists()) {
        outputFile.createNewFile()
        println "Datei erstellt: ${outputFile.absolutePath}"
    }

    // Schreibe Testinhalt in die Datei
    def now = new Date()
    outputFile.text = "TEST AGI-GDI\n\nGeneriert am: ${now}"

    println "Datei geschrieben nach: ${outputFile.absolutePath}"
    println "Dateigröße: ${outputFile.length()} bytes"
}

tasks.register('upload') {
    dependsOn 'writeTest'
    description = 'Test-Datei auf beide SFTP-Server hochladen'

    doLast {
        ssh.run {
            session(remotes.sftpServerTest) {
                put from: xtfPath, into: remotePathTest
            }
        }
        println 'Test file uploaded to FTP server TEST'

        ssh.run {
            session(remotes.sftpServerProd) {
                put from: xtfPath, into: remotePathProd
            }
        }
        println 'Test file uploaded to FTP server PROD'

    }
}

task sftpListing {
    dependsOn 'upload'
    group = 'sftp'
    description = 'Listet Dateien und Verzeichnisse von beiden SFTP-Servern auf'

    doLast {

        //TEST
        def remotePath = remotePathTest
        ssh.run {
            session(remotes.sftpServerTest) {
                // Listing mit ls
                def result = execute("ls -l ${remotePath}")
                println "=== TEST Directory Listing: ${remotePath} ==="
                println result
                println "==================================="
            }
        }

        //PROD
        remotePath = remotePathProd
        ssh.run {
            session(remotes.sftpServerProd) {
                // Listing mit ls
                def result = execute("ls -l ${remotePath}")
                println "=== PROD Directory Listing: ${remotePath} ==="
                println result
                println "==================================="
            }
        }
    }
}
